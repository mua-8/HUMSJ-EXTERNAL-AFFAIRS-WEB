rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    // For now, any authenticated user with a valid UID has access
    function isAdmin() {
      return isAuthenticated();
    }
    
    // EVENTS: Public can read, authenticated admins can manage
    match /events/{eventId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
    
    // STUDENTS / PARTICIPANTS: Centralized collection for Qirat, Dawa, Academic
    match /students/{studentId} {
      allow read, write: if isAdmin();
    }
    
    // NEW MUSLIMS: Dawa specific
    match /newMuslims/{muslimId} {
      allow read, write: if isAdmin();
    }
    
    // PROGRAMS / COURSES: Centralized management
    match /programs/{programId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // RESOURCES: Learning materials
    match /resources/{resourceId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // DISTRIBUTIONS: Charity sector management
    match /distributions/{distributionId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // REGISTRATIONS: Public can submit, admins manage
    match /registrations/{registrationId} {
      allow read, update, delete: if isAdmin();
      allow create: if true; 
    }
    
    // DONATIONS: Public can submit, admins manage
    match /donations/{donationId} {
      allow read, update, delete: if isAdmin();
      allow create: if true;
    }
    
    // SECTORS & SETTINGS: App configuration
    match /sectors/{sectorId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // GALLERY: Public viewing
    match /gallery/{imageId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // USER PROFILES: Users can read/write their own, admins all
    match /users/{userId} {
      allow read, write: if isAdmin() || (isAuthenticated() && request.auth.uid == userId);
    }

    // LEGACY: Support for /admin/ path if used by older components
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
